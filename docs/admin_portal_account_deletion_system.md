# Account Deletion System - Admin Portal Documentation

## Overview

This document outlines the account deletion system structure for the NextJS admin portal. The system allows users to request account deletion through the mobile app, with admin oversight and approval workflow.

## Database Collections Structure

### 1. `users` Collection
**Purpose**: Main user documents containing account information and deletion status flags.

```typescript
interface UserDocument {
  uid: string;                           // Firebase Auth UID (document ID)
  displayName: string;                   // User's display name
  email: string;                         // User's email address
  gender: string;                        // User's gender
  locale: string;                        // User's preferred language ('ar' | 'en')
  dayOfBirth: Timestamp;                 // User's birth date
  userFirstDate: Timestamp;              // When user first joined
  role: string;                          // User role (typically 'user')
  messagingToken?: string;               // FCM token for notifications
  
  // Account Status Flags
  isRequestedToBeDeleted?: boolean;      // TRUE when deletion is requested
  
  // Subscription Info
  isPlusUser?: boolean;                  // Premium subscription status
  lastPlusCheck?: Timestamp;             // Last subscription verification
  
  // Activity Data (Arrays of timestamp strings)
  userRelapses?: string[];               // User relapse records
  userMasturbatingWithoutWatching?: string[];  // Specific activity tracking
  userWatchingWithoutMasturbating?: string[];  // Specific activity tracking
}
```

**Key Fields for Deletion System**:
- `isRequestedToBeDeleted`: Controls account status in mobile app
- `uid`: Links to deletion requests
- `email`, `displayName`: Used for admin identification

---

### 2. `accountDeleteRequests` Collection
**Purpose**: Tracks all account deletion requests with admin workflow status.

```typescript
interface AccountDeleteRequest {
  // Document ID: Auto-generated by Firestore
  
  // User Identification
  userId: string;                        // Reference to users collection UID
  userEmail: string;                     // User email (for admin reference)
  userName: string;                      // User display name (for admin reference)
  
  // Request Details
  requestedAt: Timestamp;                // When request was submitted
  reasonId: string;                      // Deletion reason identifier
  reasonDetails?: string;                // Additional details (if required by reason)
  reasonCategory: string;                // Reason category for analytics
  
  // Workflow Status
  isCanceled: boolean;                   // User canceled the request
  isProcessed: boolean;                  // Admin processed the request
  
  // Timestamps
  canceledAt?: Timestamp;                // When user canceled (if applicable)
  processedAt?: Timestamp;               // When admin processed (if applicable)
  
  // Admin Actions
  processedBy?: string;                  // Admin UID who processed
  adminNotes?: string;                   // Admin's internal notes
}
```

**Status Flow**:
1. **New Request**: `isCanceled: false`, `isProcessed: false`
2. **User Canceled**: `isCanceled: true`, `canceledAt: timestamp`
3. **Admin Processed**: `isProcessed: true`, `processedAt: timestamp`, `processedBy: adminUID`

---

## Deletion Reasons System

### Predefined Reason Categories
```typescript
type ReasonCategory = 'privacy' | 'experience' | 'personal' | 'features' | 'content' | 'support' | 'other';

interface DeletionReason {
  id: string;                            // Unique reason identifier
  translationKey: string;                // Key for mobile app translations
  category: ReasonCategory;              // Grouping for analytics
  requiresDetails: boolean;              // Whether reason needs additional details
}
```

### Available Reasons
| Reason ID | Category | Requires Details | Purpose |
|-----------|----------|------------------|---------|
| `privacy_concerns` | privacy | No | General privacy issues |
| `data_security` | privacy | No | Data security concerns |
| `not_helpful` | experience | No | App not meeting needs |
| `too_complex` | experience | No | Usability issues |
| `technical_issues` | experience | Yes | Bugs/technical problems |
| `no_longer_needed` | personal | No | No longer relevant |
| `switching_apps` | personal | No | Moving to competitor |
| `temporary_break` | personal | No | Taking a break |
| `missing_features` | features | Yes | Feature requests |
| `content_inappropriate` | content | No | Content issues |
| `poor_support` | support | Yes | Support quality issues |
| `other` | other | Yes | Catch-all category |

---

## Account Status Flow

### Mobile App Status Enum
```typescript
enum AccountStatus {
  loading,                               // Initial state
  ok,                                    // Normal account access
  needCompleteRegistration,              // Setup required
  needConfirmDetails,                    // Profile completion needed
  needEmailVerification,                 // Email verification pending
  pendingDeletion                        // Deletion request submitted
}
```

### Status Determination Logic
1. **Check `isRequestedToBeDeleted`** → If `true`, return `pendingDeletion`
2. **Check email verification** → If unverified, return `needEmailVerification`
3. **Check profile completion** → If incomplete, return `needConfirmDetails`
4. **Default** → Return `ok`

---

## Admin Portal Data Views

### 1. Dashboard Overview
**Data Requirements**:
```typescript
interface DeletionDashboardStats {
  totalRequests: number;                 // All-time deletion requests
  pendingRequests: number;               // Unprocessed requests
  processedToday: number;                // Today's processed requests
  canceledRequests: number;              // User-canceled requests
  
  // Time-based metrics
  avgProcessingTime: number;             // Average hours to process
  requestsThisWeek: number;              // This week's new requests
  requestsThisMonth: number;             // This month's new requests
  
  // Reason breakdown
  reasonStats: {
    [category: string]: {
      count: number;
      percentage: number;
    }
  };
}
```

### 2. Request List View
**Query Parameters**:
```typescript
interface RequestListQuery {
  status?: 'pending' | 'processed' | 'canceled';
  dateRange?: {
    start: Date;
    end: Date;
  };
  reasonCategory?: ReasonCategory;
  search?: string;                       // Search by email or name
  page: number;
  limit: number;
}
```

**List Item Structure**:
```typescript
interface RequestListItem {
  id: string;                            // Document ID
  userName: string;                      // For display
  userEmail: string;                     // For identification
  requestedAt: Timestamp;                // Request date
  reasonCategory: string;                // Category badge
  reasonText: string;                    // Translated reason text
  status: 'pending' | 'processed' | 'canceled';
  daysPending?: number;                  // For pending requests
  processedBy?: string;                  // Admin name who processed
}
```

### 3. Request Detail View
**Complete Request Data**:
```typescript
interface RequestDetailView {
  // Request Information
  request: AccountDeleteRequest;
  
  // User Context
  userProfile: {
    uid: string;
    displayName: string;
    email: string;
    joinDate: Timestamp;
    lastActive?: Timestamp;
    subscriptionStatus: 'free' | 'plus';
    accountAge: number;                  // Days since registration
  };
  
  // Data Volume Summary
  dataVolume: {
    totalActivities: number;
    totalReports: number;
    storageUsed: number;                 // MB
    lastActivity: Timestamp;
  };
  
  // Deletion Impact
  deletionPreview: {
    willDelete: string[];                // List of data types
    cannotRecover: boolean;
    estimatedProcessingTime: string;     // "2-3 business days"
  };
}
```

---

## Admin Workflow States

### Request Processing States
1. **New Request**
   - Status: `pending`
   - Actions: Review, Approve, Reject, Add Notes
   - User Status: `pendingDeletion` (can still use app)

2. **Under Review**
   - Status: `pending` (with admin notes)
   - Actions: Continue review, Request more info, Approve, Reject
   - User Status: `pendingDeletion`

3. **Approved for Deletion**
   - Status: `processed`
   - Actions: Execute deletion, Add completion notes
   - User Status: Account deleted

4. **Rejected**
   - Status: `processed` (with rejection reason)
   - Actions: Send notification to user
   - User Status: Reset to `ok`

5. **User Canceled**
   - Status: `canceled`
   - Actions: Archive request
   - User Status: Reset to `ok`

---

## API Endpoints Structure

### Dashboard Endpoints
```typescript
GET /api/admin/deletion-requests/stats
GET /api/admin/deletion-requests/recent
GET /api/admin/deletion-requests/analytics/reasons
```

### Request Management
```typescript
GET /api/admin/deletion-requests?status={status}&page={page}
GET /api/admin/deletion-requests/{requestId}
POST /api/admin/deletion-requests/{requestId}/process
PUT /api/admin/deletion-requests/{requestId}/notes
```

### User Data
```typescript
GET /api/admin/users/{userId}/profile
GET /api/admin/users/{userId}/data-summary
GET /api/admin/users/{userId}/deletion-preview
```

---

## Security & Access Control

### Admin Permissions
- **View Requests**: Can see deletion requests and user summaries
- **Process Requests**: Can approve/reject deletion requests
- **Delete Data**: Can execute actual account deletion
- **View Analytics**: Can access deletion statistics and trends

### Data Privacy
- Admin can see user profile summary but not detailed activity logs
- Deletion reasons and admin notes are audit-logged
- User personal data is minimized in admin views
- All admin actions are timestamped and attributed

---

## Analytics & Reporting

### Key Metrics to Track
1. **Volume Metrics**
   - Daily/weekly/monthly deletion requests
   - Approval vs rejection rates
   - User cancellation rates

2. **Reason Analysis**
   - Most common deletion reasons
   - Seasonal trends in deletion reasons
   - Correlation between user type and deletion reason

3. **Performance Metrics**
   - Average time from request to resolution
   - Admin response times
   - User satisfaction with process

### Data Export Capabilities
- Export deletion requests by date range
- Reason category breakdowns
- User demographic analysis (anonymized)
- Processing time reports

---

This structure provides the foundation for building a comprehensive admin portal that handles account deletion requests efficiently while maintaining user privacy and providing valuable insights for service improvement.